{"version":3,"file":"polpware-ngx-i18n-store.js","sources":["ng://@polpware/ngx-i18n-store/lib/services/resource-loader.service.ts","ng://@polpware/ngx-i18n-store/public-api.ts","ng://@polpware/ngx-i18n-store/polpware-ngx-i18n-store.ts"],"sourcesContent":["import { Injectable, NgZone } from '@angular/core';\r\n\r\nimport * as externalInterface from '@polpware/fe-dependencies';\r\nimport { replace } from '@polpware/fe-utilities';\r\n\r\nimport { loadJsonUriP } from '@polpware/fe-data';\r\nimport { I18n } from '@polpware/fe-data';\r\nimport { ResourceLoader } from '@polpware/fe-data';\r\n\r\nimport {\r\n    ISlidingExpireCache\r\n} from '@polpware/fe-data';\r\nimport {\r\n    SlidingExpirationCache\r\n} from '@polpware/fe-data';\r\n\r\nconst _ = externalInterface.underscore;\r\n\r\ninterface ILangOptionEntry {\r\n    code: string;\r\n    text: string;\r\n}\r\n\r\n/**\r\n * Verify if the given lang is valid. If the given lang is not valid,\r\n * this function returns a default one.\r\n * @private\r\n * @function validate\r\n * @param {Object} options The avaliable lang options.\r\n * @param {String} lang The requested lang code.\r\n * @returns {String} Verified lang code.\r\n */\r\nfunction validate(options: Array<ILangOptionEntry>, code: string) {\r\n    let lang = code || 'en-us';\r\n    const entry = _.find(options, e => e.code.substring(0, 2) === lang.substring(0, 2));\r\n    if (entry) {\r\n        lang = entry.code;\r\n    }\r\n\r\n    return lang;\r\n}\r\n\r\n\r\n@Injectable()\r\nexport class ResourceLoaderService {\r\n\r\n    private _resourceLoader: ResourceLoader;\r\n\r\n    constructor(ngZone: NgZone) {\r\n        const cache = new SlidingExpirationCache<any>(3 * 60, 5 * 60, ngZone);\r\n        this._resourceLoader = new ResourceLoader(cache);\r\n    }\r\n\r\n    public get resourceLoader() {\r\n        return this._resourceLoader;\r\n    }\r\n\r\n    /**\r\n     * Loads the dictionary for the given lang code.\r\n     * @function loadPromise\r\n     * @param {String} langCode The requested language code.\r\n     * @param {String}[] filter The optional language code which we are not interested in.\r\n     * @returns {Promise} The promise with the state of the loaded language dictionary.\r\n     * @throws {Error}\r\n     */\r\n    loadPromise(langCode: string, filter: string) {\r\n        const resourceLoader = this._resourceLoader;\r\n        return resourceLoader.getPromise<string>('lang.options', id => id)\r\n            .then(function(resolvedOptionsUrl) {\r\n                return loadJsonUriP(resolvedOptionsUrl);\r\n            })\r\n            .then(function(resolvedOptions) {\r\n                return validate(resolvedOptions, langCode);\r\n            })\r\n            .then(function(resolvedLangCode) {\r\n                if (resolvedLangCode === filter) {\r\n                    throw new Error('Loading the current language: ' + resolvedLangCode);\r\n                }\r\n                return resolvedLangCode;\r\n            })\r\n            .then(function(filteredLangCode) {\r\n                langCode = filteredLangCode;\r\n                return resourceLoader.getPromise<string>('lang.urlTmpl', id => id);\r\n            })\r\n            .then(function(resolvedUrlTmpl) {\r\n                return replace(resolvedUrlTmpl, { code: langCode });\r\n            })\r\n            .then(function(resolvedUrl) {\r\n                return loadJsonUriP(resolvedUrl);\r\n            })\r\n            .then(function(resolvedData) {\r\n                I18n.add(resolvedData.code, resolvedData.items);\r\n                I18n.recycleOthers(resolvedData.code);\r\n                return resolvedData;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Load lang options\r\n     * @function loadOptionPromise\r\n     * @returns {Promise}\r\n     */\r\n    loadOptionPromise() {\r\n        return this._resourceLoader.getPromise('lang.options', id => id)\r\n            .then(function(resolvedOptionsUrl) {\r\n                return loadJsonUriP(resolvedOptionsUrl);\r\n            });\r\n    }\r\n}\r\n","/*\n * Public API Surface of ngx-i18n-store\n */\n\nexport * from './lib/services/resource-loader.service';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["externalInterface.underscore"],"mappings":";;;;;AAgBA,MAAM,CAAC,GAAGA,UAA4B,CAAC;AAOvC;;;;;;;;;AASA,SAAS,QAAQ,CAAC,OAAgC,EAAE,IAAY;IAC5D,IAAI,IAAI,GAAG,IAAI,IAAI,OAAO,CAAC;IAC3B,MAAM,KAAK,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;IACpF,IAAI,KAAK,EAAE;QACP,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC;KACrB;IAED,OAAO,IAAI,CAAC;AAChB,CAAC;MAIY,qBAAqB;IAI9B,YAAY,MAAc;QACtB,MAAM,KAAK,GAAG,IAAI,sBAAsB,CAAM,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,EAAE,EAAE,MAAM,CAAC,CAAC;QACtE,IAAI,CAAC,eAAe,GAAG,IAAI,cAAc,CAAC,KAAK,CAAC,CAAC;KACpD;IAED,IAAW,cAAc;QACrB,OAAO,IAAI,CAAC,eAAe,CAAC;KAC/B;;;;;;;;;IAUD,WAAW,CAAC,QAAgB,EAAE,MAAc;QACxC,MAAM,cAAc,GAAG,IAAI,CAAC,eAAe,CAAC;QAC5C,OAAO,cAAc,CAAC,UAAU,CAAS,cAAc,EAAE,EAAE,IAAI,EAAE,CAAC;aAC7D,IAAI,CAAC,UAAS,kBAAkB;YAC7B,OAAO,YAAY,CAAC,kBAAkB,CAAC,CAAC;SAC3C,CAAC;aACD,IAAI,CAAC,UAAS,eAAe;YAC1B,OAAO,QAAQ,CAAC,eAAe,EAAE,QAAQ,CAAC,CAAC;SAC9C,CAAC;aACD,IAAI,CAAC,UAAS,gBAAgB;YAC3B,IAAI,gBAAgB,KAAK,MAAM,EAAE;gBAC7B,MAAM,IAAI,KAAK,CAAC,gCAAgC,GAAG,gBAAgB,CAAC,CAAC;aACxE;YACD,OAAO,gBAAgB,CAAC;SAC3B,CAAC;aACD,IAAI,CAAC,UAAS,gBAAgB;YAC3B,QAAQ,GAAG,gBAAgB,CAAC;YAC5B,OAAO,cAAc,CAAC,UAAU,CAAS,cAAc,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC;SACtE,CAAC;aACD,IAAI,CAAC,UAAS,eAAe;YAC1B,OAAO,OAAO,CAAC,eAAe,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC,CAAC;SACvD,CAAC;aACD,IAAI,CAAC,UAAS,WAAW;YACtB,OAAO,YAAY,CAAC,WAAW,CAAC,CAAC;SACpC,CAAC;aACD,IAAI,CAAC,UAAS,YAAY;YACvB,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,KAAK,CAAC,CAAC;YAChD,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;YACtC,OAAO,YAAY,CAAC;SACvB,CAAC,CAAC;KACV;;;;;;IAOD,iBAAiB;QACb,OAAO,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,cAAc,EAAE,EAAE,IAAI,EAAE,CAAC;aAC3D,IAAI,CAAC,UAAS,kBAAkB;YAC7B,OAAO,YAAY,CAAC,kBAAkB,CAAC,CAAC;SAC3C,CAAC,CAAC;KACV;;0FA/DQ,qBAAqB;0DAArB,qBAAqB,WAArB,qBAAqB;+CAArB,qBAAqB;cADjC,UAAU;;;AC3CX;;;;ACAA;;;;;;"}